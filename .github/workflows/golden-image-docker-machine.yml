name: Release docker-machine golden image

on:
  workflow_dispatch:
    inputs:
      builder-version:
        default: '0.1.0'

env:
  BUILDER_IMAGE: ghcr.io/phandox/packer-ansible
  WORKDIR: /workplace
  PACKER_TMPL_PATH: image-factory/images/docker-machine
  DO_TOKEN: ${{ secrets.DO_TOKEN }}


jobs:
  release:
    runs-on: ubuntu-20.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Validate Packer template 
      run: |
        docker run \
        -e PKR_VAR_DO_TOKEN="${{ env.DO_TOKEN }}" \
        -v "${GITHUB_WORKSPACE}/${{ env.PACKER_TMPL_PATH }}:${{ env.WORKDIR }}:ro" \
        -w "${{ env.WORKDIR }}" \
        "${{ env.BUILDER_IMAGE }}:${{ github.event.inputs.builder-version }}" \
        validate .
    - name: Create snapshot in Digital Ocean
      run: |
        docker run \
        -e PKR_VAR_DO_TOKEN="${{ env.DO_TOKEN }}" \
        -v "${GITHUB_WORKSPACE}/${{ env.PACKER_TMPL_PATH }}:${{ env.WORKDIR }}:ro" \
        -w "${{ env.WORKDIR }}" \
        "${{ env.BUILDER_IMAGE }}:${{ github.event.inputs.builder-version }}" \
        build .
